<!DOCTYPE html>
<html lang="en">
<head>
    <title>JAMP Node 1 - PHP-WASM Fixed 2025</title>
    <style>
        body { margin: 0; padding: 20px; background: #f0f0f0; font-family: Arial, sans-serif; }
        #status { color: green; font-weight: bold; }
        #output { 
            background: #000; color: #0f0; 
            width: 800px; height: 600px; 
            overflow: auto; padding: 10px; 
            font-family: monospace; font-size: 14px; 
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div id="status">Loading PHP-WASM Node... (Bulletproof Fix)</div>
    <div id="output"></div>
    <!-- PHP-WASM: Official, maintained, single-script load -->
    <script type="module">
        // Wait for DOM to fix any null errors
        document.addEventListener('DOMContentLoaded', async function() {
            const statusEl = document.getElementById('status');
            const outputEl = document.getElementById('output');
            let php = null;

            if (!outputEl) {
                statusEl.textContent = 'Error: DOM not ready. Refresh.';
                return;
            }

            statusEl.textContent = 'Initializing PHP 8.3...';

            try {
                // Load from IndexedDB for persistence (Phase 1.1 Auto-Save)
                const dbReq = indexedDB.open('jamp-php-db', 1);
                dbReq.onupgradeneeded = (e) => e.target.result.createObjectStore('state', { keyPath: 'id' });
                const db = await new Promise((res, rej) => {
                    dbReq.onsuccess = (e) => res(e.target.result);
                    dbReq.onerror = (e) => rej(e.target.error);
                });
                const tx = db.transaction('state', 'readonly');
                const state = await new Promise((res) => {
                    tx.objectStore('state').get('php-state').onsuccess = (e) => res(e.target.result ? e.target.result.data : null);
                });

                // Boot PHP-WASM (Phase 1.2: PHP Exec in Browser)
                const { PHP } = await import('https://cdn.jsdelivr.net/npm/@php-wasm/universal@0.0.13/php-web.mjs');
                php = await PHP.load('8.3', {
                    requestHandler: { documentRoot: "/" },
                    initialState: state  // Restore from IndexedDB
                });

                // Test boot with Alpine-like setup (install PHP extensions)
                const bootOutput = await php.run(`
                    <?php
                    // Simulate Alpine: "Install" extensions (built-in)
                    echo "PHP 8.3 Booted Successfully\\n";
                    echo "Extensions: json, openssl, sodium (for encryption)\\n";
                    echo "Current time: " . date('Y-m-d H:i:s') . "\\n";
                    // Create /data dir for JSON DB (Phase 2)
                    mkdir('/data', 0777, true);
                    file_put_contents('/data/test.json', json_encode(['status' => 'ready']));
                    ?>
                `);
                outputEl.textContent = bootOutput.text;
                statusEl.textContent = '✅ Online - Auto-Save Active (PHP 8.3 Ready)';

                // Auto-save state every 30s (Phase 1.1)
                setInterval(async () => {
                    if (php) {
                        const saveTx = db.transaction('state', 'readwrite');
                        saveTx.objectStore('state').put({ id: 'php-state', data: await php.getState() });
                        console.log('PHP State Saved to IndexedDB');
                    }
                }, 30000);

                // Health Check every 30s (Phase 1.2)
                healthCheck();

            } catch (error) {
                statusEl.textContent = '❌ Init Error: ' + error.message;
                outputEl.textContent = 'Error: ' + error.stack;
                console.error('PHP-WASM Init Failed:', error);
            }

            // Health monitoring (Phase 1.2)
            async function healthCheck() {
                try {
                    // Run PHP health script
                    const healthOut = await php.run(`
                        <?php
                        $uptime = time() - $_SERVER['REQUEST_TIME'];
                        echo json_encode(['status' => 'up', 'uptime' => $uptime, 'php' => '8.3']);
                        ?>
                    `);
                    const health = JSON.parse(healthOut.text);
                    statusEl.innerHTML = `Health: ${health.status} | Uptime: ${health.uptime}s | PHP: ${health.php}`;
                    console.log('Health OK:', health);
                } catch (e) {
                    statusEl.textContent = 'Health Failed - Self-Healing...';
                    location.reload();  // Phase 1.3
                }
                setTimeout(healthCheck, 30000);
            }

            // Service Worker stub for now (Phase 1.3) - Full in Step 5
            if ('serviceWorker' in navigator) {
                // Create inline SW blob to avoid 404
                const swCode = `
                    self.addEventListener('fetch', e => {
                        if (e.request.url.includes('/api.php')) {
                            e.respondWith(fetch(e.request).catch(() => new Response('Offline - Queued')));
                        }
                    });
                `;
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);
                navigator.serviceWorker.register(swUrl).then(() => console.log('Inline SW Registered')).catch(console.warn);
            }
        });
    </script>
</body>
</html>
