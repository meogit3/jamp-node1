<!DOCTYPE html>
<html lang="en">
<head>
    <title>JAMP Node 1</title>
    <style>body { margin: 0; padding: 20px; background: #f0f0f0; font-family: Arial; } #status { color: green; } #screen { background: #000; color: #0f0; width: 800px; height: 600px; overflow: auto; padding: 10px; }</style>
</head>
<body>
    <div id="status">Loading Node...</div>
    <div id="screen"></div>
    <script src="https://bellard.org/jslinux/jslinux.js"></script>
    <script>
        const statusEl = document.getElementById('status');
        const screenEl = document.getElementById('screen');
        let vm = null;
        // Load VM with auto-save (Phase 1.1)
        vm = new JSLinux({
            wasm_url: "https://bellard.org/jslinux/vm.js",
            kernel: "https://bellard.org/jslinux/alpine.js",
            disk: loadDisk(), // IndexedDB persistence
            autostart: true,
            memory_size: 128 * 1024 * 1024,
            vga: { fullscreen: false },
            onoutput: (str) => screenEl.innerHTML += str.replace(/\n/g, '<br>'),
            onready: () => {
                statusEl.textContent = 'Online - Auto-Save Active';
                // Auto-save every 30s (Phase 1.1)
                setInterval(() => { saveDisk(vm.get_disk_image()); console.log('VM Saved'); }, 30000);
                healthCheck(); // Phase 1.2
            }
        });
        // IndexedDB for persistence
        function saveDisk(image) { indexedDB.open('jamp-db', 1).onsuccess = (e) => e.target.result.transaction('store', 'readwrite').objectStore('store').put(image, 'vm'); }
        function loadDisk() { return new Promise(res => indexedDB.open('jamp-db', 1).onsuccess = (e) => e.target.result.transaction('store').objectStore('store').get('vm').onsuccess = (ee) => res(ee.target.result)); }
        // Health monitoring (Phase 1.2)
        async function healthCheck() {
            try {
                const res = await fetch('/health.json');
                const data = await res.json();
                statusEl.innerHTML = `Health: ${data.status} | Uptime: ${data.uptime}s`;
            } catch { statusEl.textContent = 'Offline - Self-Healing'; location.reload(); } // Phase 1.3
            setTimeout(healthCheck, 30000);
        }
        // Service Worker for P2P endpoints (Phase 1.3)
        navigator.serviceWorker.register('/sw.js');
    </script>
</body>
</html>
